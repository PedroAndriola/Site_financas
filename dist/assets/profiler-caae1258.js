import{R as X,o as z,W as K,X as W,Y,Z,v as P,_ as v,$,a0 as b,a1 as q,O as Q,M as x,a2 as ee,a3 as te,a4 as ne}from"./index-d6d1b22e.js";function se(e){let n=0;for(const i of e)i.stackId!==void 0&&n++;return n}const g=new Map;function oe(e,n){g.set(n,e)}function re(e){return g.get(e)}function _(e){for(const n of g.keys())n<e&&g.delete(n)}function ae({rawRumEvent:e,startTime:n}){if(e.type!==X.LONG_TASK)return;const i=e.long_task.id;oe(i,n)}const ie=(e,n,i)=>{const{profilingEndpointBuilder:o,applicationId:l}=n,f=le(e,n,i),c=ue(e,f),p=o.build("fetch",c);return z("Sending profile to public profiling intake",{profilingIntakeURL:p,applicationId:l,sessionId:i}),fetch(p,{body:c.data,method:"POST"})};function le(e,n,i){const o=K(n),l=de(e,n.applicationId,i),f=ce(o);return{...l,attachments:["wall-time.json"],start:new Date(e.startClocks.timeStamp).toISOString(),end:new Date(e.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:f.join(","),_dd:{clock_drift:W()}}}function ce(e){return e.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function ue(e,n){const i=new Blob([JSON.stringify(e)],{type:"application/json"}),o=new FormData;return o.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),o.append("wall-time.json",i,"wall-time.json"),{data:o,bytesCount:0}}function de(e,n,i){const o={application:{id:n}};i&&(o.session={id:i});const l=Array.from(new Set(e.views.map(c=>c.viewId)));l.length&&(o.view={id:l});const f=e.longTasks.map(c=>c.id).filter(c=>c!==void 0);return f.length&&(o.long_task={id:f}),o}const fe={sendProfile:ie},pe=/\/(?![vV]\d{1,2}\/)([^/\d?]*\d+[^/?]*)/g;function me(e){return e?e.replace(pe,"/?"):"/"}const O=(e,n)=>e||me(n),ve={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function ge(e,n,i,o,l=ve){const f=Y(Z.LONG_ANIMATION_FRAME);let c;const p=[];let r={state:"stopped"};function L(t){r.state!=="running"&&(c=t?{startClocks:t.startClocks,viewId:t.id,viewName:O(t.name,document.location.pathname)}:void 0,p.push(P(e,window,"visibilitychange",A).stop,P(e,window,"beforeunload",j).stop),m())}async function N(){await k("stopped"),p.forEach(t=>t()),_(v().relative),o.set({status:"stopped",error_reason:void 0})}function D(t){if(t.state==="running")return{cleanupTasks:t.cleanupTasks,observer:t.observer};const s=[];let a;if(e.trackLongTasks){a=new PerformanceObserver(R),a.observe({entryTypes:[B()]});const u=n.subscribe(12,h=>{ae(h)});s.push(()=>a==null?void 0:a.disconnect()),s.push(u.unsubscribe)}const d=n.subscribe(2,u=>{y({viewId:u.id,viewName:O(u.name,document.location.pathname),startClocks:u.startClocks})});return s.push(d.unsubscribe),{cleanupTasks:s,observer:a}}function m(){const t=$().Profiler;if(!t)throw o.set({status:"error",error_reason:"not-supported-by-browser"}),new Error("RUM Profiler is not supported in this browser.");T(r).catch(b);const{cleanupTasks:s,observer:a}=D(r);let d;try{d=new t({sampleInterval:l.sampleIntervalMs,maxBufferSize:Math.round(l.collectIntervalMs*1.5/l.sampleIntervalMs)})}catch(u){u instanceof Error&&u.message.includes("disabled by Document Policy")?(q.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",u),o.set({status:"error",error_reason:"missing-document-policy-header"})):o.set({status:"error",error_reason:"unexpected-exception"});return}o.set({status:"running",error_reason:void 0}),r={state:"running",startClocks:v(),profiler:d,timeoutId:Q(m,l.collectIntervalMs),longTasks:[],views:[],cleanupTasks:s,observer:a},y(c),d.addEventListener("samplebufferfull",w)}async function T(t){var s,a;if(t.state!=="running")return;I((a=(s=t.observer)===null||s===void 0?void 0:s.takeRecords())!==null&&a!==void 0?a:[]),x(t.timeoutId),t.profiler.removeEventListener("samplebufferfull",w);const{startClocks:d,longTasks:u,views:h}=t,V=v();await t.profiler.stop().then(S=>{const E=v(),G=u.length>0,H=ee(d.timeStamp,E.timeStamp)<l.minProfileDurationMs,J=se(S.samples)<l.minNumberOfSamples;!G&&(H||J)||(M(Object.assign(S,{startClocks:d,endClocks:E,clocksOrigin:te(),longTasks:u,views:h,sampleInterval:l.sampleIntervalMs})),_(V.relative))}).catch(b)}async function k(t){r.state==="running"&&(r.cleanupTasks.forEach(s=>s()),await T(r),r={state:t})}function y(t){r.state!=="running"||!t||r.views.push(t)}function M(t){var s;const a=(s=i.findTrackedSession())===null||s===void 0?void 0:s.id;fe.sendProfile(t,e,a).catch(b)}function w(){m()}function R(t){I(t.getEntries())}function I(t){if(r.state==="running")for(const s of t){if(s.duration<l.sampleIntervalMs)continue;const a=ne(s.startTime),d=re(a.relative);r.longTasks.push({id:d,duration:s.duration,entryType:s.entryType,startClocks:a})}}function A(){document.visibilityState==="hidden"&&r.state==="running"?k("paused").catch(b):document.visibilityState==="visible"&&r.state==="paused"&&m()}function j(){m()}function B(){return f?"long-animation-frame":"longtask"}function C(){return r.state==="stopped"}function F(){return r.state==="running"}function U(){return r.state==="paused"}return{start:L,stop:N,isStopped:C,isRunning:F,isPaused:U}}export{ve as DEFAULT_RUM_PROFILER_CONFIGURATION,ge as createRumProfiler};
